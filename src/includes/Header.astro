---
import Button from "../component/Button.astro";
import { localizePath } from "astro-i18next";
import { LanguageSelector } from "astro-i18next/components";
import { t } from "i18next";
---

<header class="z-[100] absolute px-body lg:h-[7.222vw] h-[88px] flex flex-row justify-between w-full items-center bg-bianco" id="navbar">
  <a href={localizePath("/")}>
    <img src="/img/assets/logo-multi.svg" alt="" class="lg:w-[11.111vw] w-[127px] lg:h-[3.472vw] h-[40px]" />
  </a>
  <div class="hamburger-icon click-menu lg:hidden block" id="icon">
    <div class="icon-1" id="a"></div>
    <div class="icon-2" id="b"></div>
  </div>
  <div class="hidden lg:flex flex-row gap-[1.944vw] items-center">
    <div class="bg-grigio-100 flex flex-row gap-[3.056vw] items-center" id="menu">
      <a href={localizePath("/Azienda")} class="btn-header">
        <p class="btn-title">
          <span class="text">{t("componenti.header.azienda")}</span>
          <span class="hover-text">{t("componenti.header.azienda")}</span>
        </p>
      </a>

      <!-- "Prodotti" menu with dropdown -->
      <div class="menu-item prodotti relative">
        <a href="#" class="hover-trigger">
          <div class="flex flex-row gap-[0.556vw]">
            <p class="btn-title">
              <span class="text">{t("componenti.header.prodotti.title")}</span>
              <span class="hover-text">{t("componenti.header.prodotti.title")}</span>
            </p>
            <img src="/img/assets/plus.svg" alt="" class="w-[1.181vw]" id="plus" />
            <img src="/img/assets/minus.svg" alt="" class="w-[1.181vw] hidden" id="minus" />
          </div>
        </a>
        <div class="submenu hidden absolute bg-grigio-200">
          <a href={localizePath("/Oleodinamica")} class="btn-header">
            <p class="btn-title">
              <span class="text">{t("componenti.header.prodotti.voce1")}</span>
              <span class="hover-text">{t("componenti.header.prodotti.voce1")}</span>
            </p>
          </a>
          <a href={localizePath("/Lubrificazione")} class="btn-header">
            <p class="btn-title">
              <span class="text">{t("componenti.header.prodotti.voce2")}</span>
              <span class="hover-text">{t("componenti.header.prodotti.voce2")}</span>
            </p>
          </a>
          <a href={localizePath("/Purificazione")} class="btn-header">
            <p class="btn-title">
              <span class="text">{t("componenti.header.prodotti.voce3")}</span>
              <span class="hover-text">{t("componenti.header.prodotti.voce3")}</span>
            </p>
          </a>
          <a href={localizePath("/Disaereazione")} class="btn-header">
            <p class="btn-title">
              <span class="text">{t("componenti.header.prodotti.voce4")}</span>
              <span class="hover-text">{t("componenti.header.prodotti.voce4")}</span>
            </p>
          </a>
          <a href={localizePath("/Cilindri")} class="btn-header">
            <p class="btn-title">
              <span class="text">{t("componenti.header.prodotti.voce5")}</span>
              <span class="hover-text">{t("componenti.header.prodotti.voce5")}</span>
            </p>
          </a>
        </div>
      </div>

      <!-- "Servizi" menu with dropdown -->
      <div class="menu-item servizi relative">
        <a href="#" class="hover-trigger">
          <div class="flex flex-row gap-[0.556vw]">
            <p class="btn-title">
              <span class="text">{t("componenti.header.servizi.title")}</span>
              <span class="hover-text">{t("componenti.header.servizi.title")}</span>
            </p>
            <img src="/img/assets/plus.svg" alt="" class="w-[1.181vw]" id="plus" />
            <img src="/img/assets/minus.svg" alt="" class="w-[1.181vw] hidden" id="minus" />
          </div>
        </a>
        <div class="submenu hidden absolute bg-grigio-200">
          <a href={localizePath("/Ricambi_e_Componentistica")} class="btn-header">
            <p class="btn-title">
              <span class="text">{t("componenti.header.servizi.voce1")}</span>
              <span class="hover-text">{t("componenti.header.servizi.voce1")}</span>
            </p>
          </a>
          <a href={localizePath("/AutomazioneIndustriale")} class="btn-header">
            <p class="btn-title">
              <span class="text">{t("componenti.header.servizi.voce2")}</span>
              <span class="hover-text">{t("componenti.header.servizi.voce2")}</span>
            </p>
          </a>
          <a href={localizePath("/PuliziaFiltraggio")} class="btn-header">
            <p class="btn-title">
              <span class="text">{t("componenti.header.servizi.voce3")}</span>
              <span class="hover-text">{t("componenti.header.servizi.voce3")}</span>
            </p>
          </a>
          <a href={localizePath("/Engineering")} class="btn-header">
            <p class="btn-title">
              <span class="text">{t("componenti.header.servizi.voce4")}</span>
              <span class="hover-text">{t("componenti.header.servizi.voce4")}</span>
            </p>
          </a>
          <a href={localizePath("/ManutenzioneAssistenza")} class="btn-header">
            <p class="btn-title">
              <span class="text">{t("componenti.header.servizi.voce5")}</span>
              <span class="hover-text">{t("componenti.header.servizi.voce5")}</span>
            </p>
          </a>
        </div>
      </div>

      <a href={localizePath("/Progetti")} class="btn-header">
        <p class="btn-title">
          <span class="text">{t("componenti.header.progetti")}</span>
          <span class="hover-text">{t("componenti.header.progetti")}</span>
        </p>
      </a>
      <!-- <a href={localizePath("/AreaRiservata")} class="btn-header">
        <p class="btn-title">
          <span class="text">{t("componenti.header.areaRiservata")}</span>
          <span class="hover-text">{t("componenti.header.areaRiservata")}</span>
        </p>
      </a> -->
      <Button content={t("componenti.header.contatti")} type="btn-white" link={localizePath("/Contatti")} />
    </div>
    <div class="relative">
      <div class="flex flex-row gap-[0.278vw]">
        <LanguageSelector showFlag={false} languageMapping={{ en: "EN", it: "IT" }} class="abosolute" />
        <img src="/img/assets/globe.svg" alt="" />
      </div>
    </div>
  </div>

  <style>
    /* Define hidden class for controlling visibility */

    /* Basic styles for the submenu */
    .submenu {
      display: none;
      position: absolute;
      top: 4vw;
      left: 0;
      background-color: #e0e0e0;
      padding: 1.667vw;
      border-radius: 0.833vw;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      z-index: 10;
      width: fit-content;
      flex-direction: column;
      gap: 1.111vw;
    }

    .submenu.show {
      display: flex;
    }
  </style>

  <script>
    // Funzione per inizializzare i menu
    function initializeMenu() {
      console.log("Initializing menus...");

      // Seleziona tutti i menu
      const menuItems = document.querySelectorAll(".menu-item");

      // Funzione per chiudere tutti i sottomenù
      function closeAllSubmenus() {
        console.log("Closing all submenus...");
        menuItems.forEach((menuItem) => {
          const submenu = menuItem.querySelector(".submenu");
          const plusIcon = menuItem.querySelector("#plus");
          const minusIcon = menuItem.querySelector("#minus");

          submenu?.classList.remove("show");
          plusIcon?.classList.remove("hidden");
          minusIcon?.classList.add("hidden");
        });
      }

      // Chiude tutti i sottomenù durante l'inizializzazione
      closeAllSubmenus();

      // Gestisce i click sui menu principali
      menuItems.forEach((menuItem) => {
        const trigger = menuItem.querySelector(".hover-trigger");
        const submenu = menuItem.querySelector(".submenu");
        const plusIcon = menuItem.querySelector("#plus");
        const minusIcon = menuItem.querySelector("#minus");

        if (!trigger || !submenu) return; // Se mancano elementi, salta

        trigger.addEventListener("click", (event) => {
          event.preventDefault();
          console.log(`Toggled menu: ${menuItem.classList}`);

          // Usa lo stato del DOM per verificare visibilità
          const isCurrentlyVisible = submenu.classList.contains("show");
          console.log(isCurrentlyVisible);

          // Chiude tutti i sottomenù
          closeAllSubmenus();

          console.log(isCurrentlyVisible);

          // Apre il sottomenu corrente se non era già visibile
          if (!isCurrentlyVisible) {
            submenu.classList.add("show");
            plusIcon?.classList.add("hidden");
            minusIcon?.classList.remove("hidden");
          }
        });
      });

      // Chiude i sottomenù cliccando fuori
      document.addEventListener("click", (event) => {
        const target = event.target;
        const clickedInsideMenu = [...menuItems].some((menuItem) => menuItem.contains(target));

        if (!clickedInsideMenu) {
          console.log("Clicked outside menus, closing all submenus.");
          closeAllSubmenus();
        }
      });
    }

    // Eventi per Astro
    document.addEventListener("astro:page-load", () => {
      console.log("astro:page-load triggered");
      initializeMenu();
    });

    // Per SPA: ricarica menu dopo una navigazione
    document.addEventListener("astro:after-swap", () => {
      console.log("astro:after-swap triggered");
      initializeMenu();
    });
  </script>
</header>
